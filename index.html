<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Free GPT</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bgLight: '#f7f7f8',
            bgDark: '#1e1f20'
          }
        }
      }
    }
  </script>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html, body {
      height: 100%;
    }
    /* Prevent mobile input from being hidden */
    body {
      padding-bottom: env(safe-area-inset-bottom);
    }
  </style>
</head>

<body class="bg-bgLight dark:bg-bgDark text-gray-900 dark:text-gray-100">
  <!-- Loader -->
  <div id="loading" class="flex items-center justify-center min-h-screen">
    <div class="text-lg font-medium">Loading App...</div>
  </div>

  <!-- App -->
  <div id="app" class="hidden min-h-screen flex flex-col">
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <aside id="sidebar" class="w-64 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 flex-shrink-0 transform transition-transform duration-200 md:translate-x-0 -translate-x-full md:block fixed md:static inset-y-0 z-30">
        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
          <span class="font-semibold">Free GPT</span>
          <button id="newChatBtn" class="text-sm px-2 py-1 rounded bg-gray-200 dark:bg-gray-700">New</button>
        </div>
        <div id="chatList" class="overflow-y-auto p-2 space-y-1 text-sm"></div>
      </aside>

      <!-- Main -->
      <main class="flex flex-col flex-1 min-w-0">
        <!-- Top bar -->
        <div class="flex items-center justify-between p-2 border-b dark:border-gray-700">
          <button id="sidebarToggle" class="md:hidden px-2 py-1">â˜°</button>
          <div class="flex items-center gap-2">
            <button id="settingsBtn" class="px-2 py-1 text-sm">Settings</button>
            <button id="darkToggle" class="px-2 py-1 text-sm">ðŸŒ™</button>
          </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

        <!-- Input -->
        <div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 p-3">
          <form id="chatForm" class="flex gap-2">
            <textarea id="userInput" rows="1" class="flex-1 resize-none p-2 rounded border dark:bg-gray-800 dark:border-gray-600" placeholder="Send a message"></textarea>
            <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white">Send</button>
          </form>
        </div>
      </main>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-40">
    <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded p-4 space-y-3">
      <h2 class="font-semibold text-lg">Settings</h2>

      <label class="block text-sm">
        OpenRouter API Key
        <input id="apiKeyInput" type="password" class="w-full p-2 mt-1 rounded border dark:bg-gray-800 dark:border-gray-600">
      </label>

      <label class="block text-sm">
        Model
        <input id="modelInput" type="text" class="w-full p-2 mt-1 rounded border dark:bg-gray-800 dark:border-gray-600">
      </label>

      <label class="block text-sm">
        System Prompt (Global)
        <textarea id="systemPromptInput" rows="3" class="w-full p-2 mt-1 rounded border dark:bg-gray-800 dark:border-gray-600"></textarea>
      </label>

      <div class="flex justify-end gap-2 pt-2">
        <button id="closeSettings" class="px-3 py-1">Close</button>
        <button id="saveSettings" class="px-3 py-1 bg-blue-600 text-white rounded">Save</button>
      </div>
    </div>
  </div>

  <!-- Script (END OF BODY ONLY) -->
  <script>
    (function () {
      const qs = (id) => document.getElementById(id);

      const state = {
        chats: JSON.parse(localStorage.getItem('chats') || '[]'),
        currentChatId: localStorage.getItem('currentChatId'),
        apiKey: localStorage.getItem('apiKey') || '',
        model: localStorage.getItem('model') || 'deepseek/deepseek-r1:free',
        systemPrompt: localStorage.getItem('systemPrompt') || '',
        dark: localStorage.getItem('dark') === '1'
      };

      if (state.dark) document.documentElement.classList.add('dark');

      function saveState() {
        localStorage.setItem('chats', JSON.stringify(state.chats));
        localStorage.setItem('currentChatId', state.currentChatId || '');
      }

      function createChat() {
        const chat = {
          id: crypto.randomUUID(),
          name: 'New Chat',
          messages: []
        };
        state.chats.unshift(chat);
        state.currentChatId = chat.id;
        saveState();
        renderChats();
        renderMessages();
      }

      function currentChat() {
        return state.chats.find(c => c.id === state.currentChatId);
      }

      function renderChats() {
        const list = qs('chatList');
        list.innerHTML = '';
        state.chats.forEach(chat => {
          const item = document.createElement('div');
          item.className = 'flex items-center justify-between px-2 py-1 rounded cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700';
          if (chat.id === state.currentChatId) {
            item.classList.add('bg-gray-200', 'dark:bg-gray-700');
          }

          const title = document.createElement('span');
          title.textContent = chat.name;
          title.onclick = () => {
            state.currentChatId = chat.id;
            saveState();
            renderChats();
            renderMessages();
          };

          const del = document.createElement('button');
          del.textContent = 'âœ•';
          del.onclick = (e) => {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== chat.id);
            if (state.currentChatId === chat.id) {
              state.currentChatId = state.chats[0]?.id || null;
            }
            saveState();
            renderChats();
            renderMessages();
          };

          item.append(title, del);
          list.appendChild(item);
        });
      }

      function renderMessages() {
        const container = qs('messages');
        container.innerHTML = '';
        const chat = currentChat();
        if (!chat) return;

        chat.messages.forEach(msg => {
          const bubble = document.createElement('div');
          bubble.className = msg.role === 'user'
            ? 'ml-auto max-w-[80%] p-3 rounded bg-blue-600 text-white'
            : 'mr-auto max-w-[80%] p-3 rounded bg-gray-200 dark:bg-gray-700';

          bubble.innerHTML = msg.role === 'assistant'
            ? marked.parse(msg.content || '')
            : msg.content;

          container.appendChild(bubble);
        });

        container.scrollTop = container.scrollHeight;
      }

      async function sendMessage(text) {
        if (!state.apiKey) {
          alert('Set API key first');
          return;
        }

        const chat = currentChat();
        if (!chat) return;

        chat.messages.push({ role: 'user', content: text });
        renderMessages();
        saveState();

        const assistantMsg = { role: 'assistant', content: '' };
        chat.messages.push(assistantMsg);
        renderMessages();

        const body = {
          model: state.model,
          stream: true,
          messages: [
            ...(state.systemPrompt ? [{ role: 'system', content: state.systemPrompt }] : []),
            ...chat.messages
          ]
        };

        const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.apiKey
          },
          body: JSON.stringify(body)
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          chunk.split('\n').forEach(line => {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') return;
              try {
                const json = JSON.parse(data);
                const delta = json.choices?.[0]?.delta?.content;
                if (delta) {
                  assistantMsg.content += delta;
                  renderMessages();
                }
              } catch {}
            }
          });
        }

        saveState();
      }

      /* UI Wiring */
      qs('chatForm').onsubmit = (e) => {
        e.preventDefault();
        const input = qs('userInput');
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        sendMessage(text);
      };

      qs('newChatBtn').onclick = createChat;
      qs('sidebarToggle').onclick = () => qs('sidebar').classList.toggle('-translate-x-full');
      qs('settingsBtn').onclick = () => qs('settingsModal').classList.remove('hidden');
      qs('closeSettings').onclick = () => qs('settingsModal').classList.add('hidden');

      qs('saveSettings').onclick = () => {
        state.apiKey = qs('apiKeyInput').value.trim();
        state.model = qs('modelInput').value.trim() || state.model;
        state.systemPrompt = qs('systemPromptInput').value.trim();
        localStorage.setItem('apiKey', state.apiKey);
        localStorage.setItem('model', state.model);
        localStorage.setItem('systemPrompt', state.systemPrompt);
        qs('settingsModal').classList.add('hidden');
      };

      qs('darkToggle').onclick = () => {
        document.documentElement.classList.toggle('dark');
        state.dark = document.documentElement.classList.contains('dark');
        localStorage.setItem('dark', state.dark ? '1' : '0');
      };

      /* Init */
      qs('apiKeyInput').value = state.apiKey;
      qs('modelInput').value = state.model;
      qs('systemPromptInput').value = state.systemPrompt;

      if (!state.currentChatId && state.chats.length) {
        state.currentChatId = state.chats[0].id;
      }
      if (!state.chats.length) createChat();

      renderChats();
      renderMessages();

      qs('loading').classList.add('hidden');
      qs('app').classList.remove('hidden');
    })();
  </script>
</body>
</html>
